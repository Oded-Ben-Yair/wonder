<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEO Engine Playground</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group input {
            width: auto;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            flex: 1;
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #5a67d8;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        button.secondary {
            background: #48bb78;
        }
        
        button.secondary:hover {
            background: #38a169;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .metrics {
            display: flex;
            gap: 20px;
        }
        
        .metric {
            display: flex;
            flex-direction: column;
        }
        
        .metric-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        .metric-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tr:hover {
            background: #f7fafc;
        }
        
        .score {
            display: inline-block;
            padding: 4px 8px;
            background: #667eea;
            color: white;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .expandable {
            margin-top: 20px;
        }
        
        .expandable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f7fafc;
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
        }
        
        .expandable-header:hover {
            background: #edf2f7;
        }
        
        .expandable-content {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 6px;
        }
        
        .expandable-content.show {
            display: block;
        }
        
        pre {
            background: #2d3748;
            color: #48bb78;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
        
        .compare-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .engine-select {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .engine-select select {
            flex: 1;
        }
        
        .sparkline {
            margin-top: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
        }
        
        canvas {
            width: 100%;
            height: 100px;
        }
        
        .cost-estimator {
            margin-top: 20px;
            padding: 15px;
            background: #fef5e7;
            border-radius: 6px;
            border: 2px solid #f39c12;
        }
        
        .cost-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .success {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ CEO Engine Playground</h1>
        
        <div class="main-grid">
            <!-- Left Panel: Request Form -->
            <div class="panel">
                <h2>Request Configuration</h2>
                
                <div class="form-group">
                    <label for="city">City *</label>
                    <input type="text" id="city" value="Tel Aviv" required>
                </div>
                
                <div class="form-group">
                    <label for="services">Services (comma-separated)</label>
                    <input type="text" id="services" placeholder="General Care, Pediatric Care">
                </div>
                
                <div class="form-group">
                    <label for="expertise">Expertise (comma-separated)</label>
                    <input type="text" id="expertise" placeholder="emergency, pediatrics">
                </div>
                
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="urgent">
                    <label for="urgent">Urgent Request</label>
                </div>
                
                <div class="form-group">
                    <label for="topK">Top K Results</label>
                    <input type="number" id="topK" min="1" max="10" value="5">
                </div>
                
                <div class="form-group">
                    <label for="engine">Engine</label>
                    <select id="engine">
                        <option value="">Loading engines...</option>
                    </select>
                </div>
                
                <div class="button-group">
                    <button id="runBtn" onclick="runMatch()">üéØ Run Match</button>
                    <button class="secondary" onclick="toggleCompare()">‚öñÔ∏è A/B Compare</button>
                </div>
                
                <div id="comparePanel" style="display: none; margin-top: 20px;">
                    <h3>A/B Comparison</h3>
                    <div class="engine-select">
                        <select id="engineA">
                            <option value="">Engine A</option>
                        </select>
                        <select id="engineB">
                            <option value="">Engine B</option>
                        </select>
                    </div>
                    <button onclick="runCompare()">üî¨ Compare Engines</button>
                </div>
                
                <div class="button-group" style="margin-top: 20px;">
                    <button onclick="copyLink()">üîó Copy Link</button>
                    <button onclick="downloadJSON()">üíæ Download JSON</button>
                </div>
                
                <!-- Cost Estimator -->
                <div class="cost-estimator">
                    <h3>üí∞ Cost Estimator</h3>
                    <div class="cost-inputs">
                        <div>
                            <label for="costPer1k">$/1k tokens</label>
                            <input type="number" id="costPer1k" value="0.03" step="0.001">
                        </div>
                        <div>
                            <label for="tokenEstimate">Est. Tokens</label>
                            <input type="number" id="tokenEstimate" value="500" readonly>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>Estimated Cost: $<span id="costDisplay">0.015</span></strong>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel: Results -->
            <div class="panel">
                <div class="results-header">
                    <h2>Results</h2>
                    <div class="metrics">
                        <div class="metric">
                            <span class="metric-label">Latency</span>
                            <span class="metric-value" id="latency">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Engine</span>
                            <span class="metric-value" id="engineName">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Status</span>
                            <span class="metric-value" id="status">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Processing request...</p>
                </div>
                
                <div id="resultsContent">
                    <p style="color: #666; text-align: center; padding: 40px;">
                        Configure your request and click "Run Match" to see results
                    </p>
                </div>
                
                <div id="compareResults" style="display: none;"></div>
                
                <!-- Sparkline -->
                <div class="sparkline">
                    <h3>Score Distribution</h3>
                    <canvas id="sparkline"></canvas>
                </div>
                
                <!-- Expandable Raw Data -->
                <div class="expandable">
                    <div class="expandable-header" onclick="toggleExpand('rawData')">
                        <span>üìä Raw Request/Response</span>
                        <span id="rawDataToggle">‚ñ∂</span>
                    </div>
                    <div class="expandable-content" id="rawData">
                        <pre id="rawContent">No data yet</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let lastResponse = null;
        let engines = [];
        
        // Get API base URL - automatically detect or use configured
        function getApiBaseUrl() {
            // Check if we're running from a different domain (deployed)
            const currentHost = window.location.host;
            
            // If we're on a deployment platform, use relative URLs
            if (currentHost.includes('ngrok') || 
                currentHost.includes('onrender.com') || 
                currentHost.includes('railway.app') ||
                !currentHost.includes('localhost')) {
                return ''; // Use relative URLs
            }
            
            // For local development
            return window.API_BASE_URL || '';
        }
        
        // Initialize on load
        window.addEventListener('load', async () => {
            await loadEngines();
            loadFromHash();
            updateCostEstimate();
        });
        
        async function loadEngines() {
            try {
                const response = await fetch(getApiBaseUrl() + '/engines');
                const data = await response.json();
                engines = data.engines;
                
                // Populate engine dropdowns
                const engineSelect = document.getElementById('engine');
                const engineA = document.getElementById('engineA');
                const engineB = document.getElementById('engineB');
                
                engineSelect.innerHTML = '<option value="">Auto (First Available)</option>';
                engineA.innerHTML = '<option value="">Select Engine A</option>';
                engineB.innerHTML = '<option value="">Select Engine B</option>';
                
                engines.forEach(engine => {
                    const option = `<option value="${engine.name}" ${!engine.healthy ? 'disabled' : ''}>
                        ${engine.name} ${engine.healthy ? '‚úÖ' : '‚ùå'}
                    </option>`;
                    engineSelect.innerHTML += option;
                    engineA.innerHTML += option;
                    engineB.innerHTML += option;
                });
            } catch (error) {
                console.error('Failed to load engines:', error);
            }
        }
        
        async function runMatch() {
            const loading = document.getElementById('loading');
            const resultsContent = document.getElementById('resultsContent');
            
            loading.classList.add('show');
            resultsContent.innerHTML = '';
            
            const request = buildRequest();
            
            try {
                const startTime = Date.now();
                const response = await fetch(getApiBaseUrl() + '/match', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(request)
                });
                
                const data = await response.json();
                const endTime = Date.now();
                
                lastResponse = data;
                
                // Update metrics
                document.getElementById('latency').textContent = `${data.latency_ms || (endTime - startTime)}ms`;
                document.getElementById('engineName').textContent = data.engine || 'Unknown';
                document.getElementById('status').textContent = response.ok ? '200' : response.status;
                
                // Display results
                if (response.ok) {
                    displayResults(data.results || []);
                    drawSparkline(data.results || []);
                } else {
                    resultsContent.innerHTML = `<div class="error">Error: ${data.error || 'Unknown error'}<br>${data.message || ''}</div>`;
                }
                
                // Update raw data
                document.getElementById('rawContent').textContent = JSON.stringify(
                    { request, response: data },
                    null,
                    2
                );
                
                // Update URL hash
                updateHash();
                
                // Update cost estimate
                updateCostEstimate(data);
                
            } catch (error) {
                resultsContent.innerHTML = `<div class="error">Network error: ${error.message}</div>`;
            } finally {
                loading.classList.remove('show');
            }
        }
        
        async function runCompare() {
            const engineA = document.getElementById('engineA').value;
            const engineB = document.getElementById('engineB').value;
            
            if (!engineA || !engineB) {
                alert('Please select both engines for comparison');
                return;
            }
            
            const loading = document.getElementById('loading');
            const compareResults = document.getElementById('compareResults');
            const resultsContent = document.getElementById('resultsContent');
            
            loading.classList.add('show');
            resultsContent.style.display = 'none';
            compareResults.style.display = 'block';
            compareResults.innerHTML = '';
            
            const request = buildRequest();
            
            try {
                // Run both engines in parallel
                const [responseA, responseB] = await Promise.all([
                    fetch(getApiBaseUrl() + `/match?engine=${engineA}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(request)
                    }),
                    fetch(getApiBaseUrl() + `/match?engine=${engineB}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(request)
                    })
                ]);
                
                const [dataA, dataB] = await Promise.all([
                    responseA.json(),
                    responseB.json()
                ]);
                
                displayComparison(
                    { engine: engineA, data: dataA, ok: responseA.ok },
                    { engine: engineB, data: dataB, ok: responseB.ok }
                );
                
            } catch (error) {
                compareResults.innerHTML = `<div class="error">Comparison failed: ${error.message}</div>`;
            } finally {
                loading.classList.remove('show');
            }
        }
        
        function buildRequest() {
            return {
                city: document.getElementById('city').value,
                servicesQuery: document.getElementById('services').value
                    .split(',')
                    .map(s => s.trim())
                    .filter(s => s),
                expertiseQuery: document.getElementById('expertise').value
                    .split(',')
                    .map(s => s.trim())
                    .filter(s => s),
                urgent: document.getElementById('urgent').checked,
                topK: parseInt(document.getElementById('topK').value),
                engine: document.getElementById('engine').value || undefined
            };
        }
        
        function displayResults(results) {
            const resultsContent = document.getElementById('resultsContent');
            
            if (!results || results.length === 0) {
                resultsContent.innerHTML = '<p style="color: #666; text-align: center;">No results found</p>';
                return;
            }
            
            let html = '<table><thead><tr><th>ID</th><th>Name</th><th>Score</th><th>Reason</th></tr></thead><tbody>';
            
            results.forEach(result => {
                html += `
                    <tr>
                        <td>${result.id}</td>
                        <td>${result.name || '-'}</td>
                        <td><span class="score">${(result.score || 0).toFixed(3)}</span></td>
                        <td>${result.reason || '-'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            resultsContent.innerHTML = html;
        }
        
        function displayComparison(resultA, resultB) {
            const compareResults = document.getElementById('compareResults');
            
            let html = '<div class="compare-grid">';
            
            // Engine A results
            html += '<div>';
            html += `<h3>${resultA.engine} ${resultA.ok ? '‚úÖ' : '‚ùå'}</h3>`;
            if (resultA.ok && resultA.data.results) {
                html += `<p>Latency: ${resultA.data.latency_ms}ms</p>`;
                html += '<table><thead><tr><th>ID</th><th>Score</th></tr></thead><tbody>';
                resultA.data.results.forEach(r => {
                    html += `<tr><td>${r.id}</td><td>${(r.score || 0).toFixed(3)}</td></tr>`;
                });
                html += '</tbody></table>';
            } else {
                html += `<div class="error">Error: ${resultA.data.error || 'Failed'}</div>`;
            }
            html += '</div>';
            
            // Engine B results
            html += '<div>';
            html += `<h3>${resultB.engine} ${resultB.ok ? '‚úÖ' : '‚ùå'}</h3>`;
            if (resultB.ok && resultB.data.results) {
                html += `<p>Latency: ${resultB.data.latency_ms}ms</p>`;
                html += '<table><thead><tr><th>ID</th><th>Score</th></tr></thead><tbody>';
                resultB.data.results.forEach(r => {
                    html += `<tr><td>${r.id}</td><td>${(r.score || 0).toFixed(3)}</td></tr>`;
                });
                html += '</tbody></table>';
            } else {
                html += `<div class="error">Error: ${resultB.data.error || 'Failed'}</div>`;
            }
            html += '</div>';
            
            html += '</div>';
            
            // Diff analysis
            if (resultA.ok && resultB.ok && resultA.data.results && resultB.data.results) {
                const idsA = new Set(resultA.data.results.map(r => r.id));
                const idsB = new Set(resultB.data.results.map(r => r.id));
                
                const onlyInA = [...idsA].filter(id => !idsB.has(id));
                const onlyInB = [...idsB].filter(id => !idsA.has(id));
                const inBoth = [...idsA].filter(id => idsB.has(id));
                
                html += '<div style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 6px;">';
                html += '<h3>Difference Analysis</h3>';
                html += `<p>Common results: ${inBoth.length}</p>`;
                html += `<p>Only in ${resultA.engine}: ${onlyInA.join(', ') || 'None'}</p>`;
                html += `<p>Only in ${resultB.engine}: ${onlyInB.join(', ') || 'None'}</p>`;
                html += '</div>';
            }
            
            compareResults.innerHTML = html;
        }
        
        function drawSparkline(results) {
            const canvas = document.getElementById('sparkline');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.offsetWidth;
            canvas.height = 100;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!results || results.length === 0) return;
            
            const scores = results.map(r => r.score || 0);
            const max = Math.max(...scores);
            const min = Math.min(...scores);
            const range = max - min || 1;
            
            const width = canvas.width;
            const height = canvas.height;
            const padding = 10;
            
            // Draw grid lines
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding + (height - 2 * padding) * i / 4;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Draw sparkline
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            scores.forEach((score, i) => {
                const x = (i / (scores.length - 1)) * (width - 2 * padding) + padding;
                const y = height - padding - ((score - min) / range) * (height - 2 * padding);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Draw points
            ctx.fillStyle = '#667eea';
            scores.forEach((score, i) => {
                const x = (i / (scores.length - 1)) * (width - 2 * padding) + padding;
                const y = height - padding - ((score - min) / range) * (height - 2 * padding);
                
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, 2 * Math.PI);
                ctx.fill();
            });
        }
        
        function toggleCompare() {
            const panel = document.getElementById('comparePanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            
            if (panel.style.display === 'block') {
                document.getElementById('resultsContent').style.display = 'block';
                document.getElementById('compareResults').style.display = 'none';
            }
        }
        
        function toggleExpand(id) {
            const content = document.getElementById(id);
            const toggle = document.getElementById(id + 'Toggle');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                toggle.textContent = '‚ñ∂';
            } else {
                content.classList.add('show');
                toggle.textContent = '‚ñº';
            }
        }
        
        function updateHash() {
            const state = {
                city: document.getElementById('city').value,
                services: document.getElementById('services').value,
                expertise: document.getElementById('expertise').value,
                urgent: document.getElementById('urgent').checked,
                topK: document.getElementById('topK').value,
                engine: document.getElementById('engine').value
            };
            
            window.location.hash = btoa(JSON.stringify(state));
        }
        
        function loadFromHash() {
            if (!window.location.hash) return;
            
            try {
                const state = JSON.parse(atob(window.location.hash.substring(1)));
                
                document.getElementById('city').value = state.city || 'Tel Aviv';
                document.getElementById('services').value = state.services || '';
                document.getElementById('expertise').value = state.expertise || '';
                document.getElementById('urgent').checked = state.urgent || false;
                document.getElementById('topK').value = state.topK || 5;
                document.getElementById('engine').value = state.engine || '';
            } catch (error) {
                console.error('Failed to load from hash:', error);
            }
        }
        
        function copyLink() {
            updateHash();
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert('Link copied to clipboard!');
            });
        }
        
        function downloadJSON() {
            if (!lastResponse) {
                alert('No data to download. Run a match first.');
                return;
            }
            
            const blob = new Blob([JSON.stringify(lastResponse, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `match-results-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function updateCostEstimate(response) {
            const costPer1k = parseFloat(document.getElementById('costPer1k').value);
            let tokens = parseInt(document.getElementById('tokenEstimate').value);
            
            // Estimate tokens from response if available
            if (response && response.usage) {
                tokens = response.usage.total_tokens || tokens;
                document.getElementById('tokenEstimate').value = tokens;
            }
            
            const cost = (tokens / 1000) * costPer1k;
            document.getElementById('costDisplay').textContent = cost.toFixed(4);
        }
        
        // Update cost on input change
        document.getElementById('costPer1k').addEventListener('input', updateCostEstimate);
    </script>
</body>
</html>